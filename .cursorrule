# ====================================================================
#  .cursorrule  â”€â”€ Twilio Ã— OpenAI Realtime API on AWS â€“ Implementation Guide
# ====================================================================

###############################################################################
# 1. ç›®çš„ (Purpose)
###############################################################################
- Twilio Programmable Voice + Media Streams ã‚’é€šã˜ã¦å—ä¿¡ã—ãŸé€šè©±éŸ³å£°ã‚’  
  OpenAI Realtime API (GPT-4o Realtime) ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã—ã€ç”ŸæˆéŸ³å£°ã‚’  
  å³æ™‚æŠ˜è¿”ã—ã™ã‚‹ä½é…å»¶ Voice Bot ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚  
- ãƒ­ãƒ¼ã‚«ãƒ«ä¾å­˜ã‚’æ’é™¤ã—ã€**ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ãª AWS ã‚µãƒ¼ãƒ“ã‚¹**ã§æœ¬ç•ªé‹ç”¨å¯èƒ½ãª  
  ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ« / é«˜å¯ç”¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç¢ºç«‹ã™ã‚‹ã€‚  
- ã‚»ã‚­ãƒ¥ã‚¢ãª Secrets ç®¡ç†ã€CI/CDã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° & ã‚³ã‚¹ãƒˆç®¡ç†ã‚’å«ã‚€  
  ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã® DevOps ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ•´å‚™ã™ã‚‹ã€‚

###############################################################################
# 2. å…¨ä½“æ–¹é‡ (Global Strategy)
###############################################################################
## 2.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†é›¢
1. **Web / ç®¡ç† UI**â€ƒâ†’ Next.js (App Router) ã‚’ Amplify Hosting SSR ãƒ¢ãƒ¼ãƒ‰ã¸ãƒ‡ãƒ—ãƒ­ã‚¤  
   (CloudFront + Lambda@Edge ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«é…ä¿¡) :contentReference[oaicite:0]{index=0}  
2. **Twilio Voice Webhook**â€ƒâ†’ API Gateway HTTP API + AWS Lambda  
   - 15 sec Hard Timeout ã‚’è€ƒæ…®ã—ã€Lambda ã« *Provisioned Concurrency=1* ã‚’è¨­å®š :contentReference[oaicite:1]{index=1}  
3. **éŸ³å£°ãƒ¡ãƒ‡ã‚£ã‚¢ â‡” OpenAI Bridge**â€ƒâ†’ WebSocket ã‚µãƒ¼ãƒ (Node.js) ã‚’  
   ECS on Fargate (arm64) behind ALB ã«å¸¸é§  
   - Twilio <Connect><Stream> ã§åŒæ–¹å‘ WebSocket (bidirectional) æ¥ç¶š :contentReference[oaicite:2]{index=2}  

## 2.2 æ¨å¥¨ AWS ã‚µãƒ¼ãƒ“ã‚¹
- **é™çš„ã‚¢ã‚»ãƒƒãƒˆ**â€ƒS3 + CloudFront  
- **æ©Ÿå¯†å€¤**â€ƒSecrets Manager (ECS/Lambda ã¸ç’°å¢ƒå¤‰æ•°æ³¨å…¥) :contentReference[oaicite:3]{index=3}  
- **CI/CD**â€ƒGitHub Actions â†’ ECR/ECS & Amplify  
- **ãƒ­ã‚°/ç›£è¦–**â€ƒCloudWatch Logs + X-Ray/ServiceLens :contentReference[oaicite:4]{index=4}  
- **ã‚¹ã‚±ãƒ¼ãƒ«**â€ƒECS Auto Scaling (ActiveConnections + CPU) :contentReference[oaicite:5]{index=5}  
  Lambda = Auto + Provisioned, API Gateway WebSocket 2 h é€£ç¶šæ¥ç¶šä¸Šé™ :contentReference[oaicite:6]{index=6}  

## 2.3 ã‚³ã‚¹ãƒˆæŒ‡é‡
- Twilio Media Streams: **$0.004/min** + Programmable Voice é€šè©±æ–™ :contentReference[oaicite:7]{index=7}  
- OpenAI Realtime: audio in â‰’ $0.06/min, audio out â‰’ $0.24/min :contentReference[oaicite:8]{index=8}  

###############################################################################
# 3. å®Ÿè£…æ‰‹é † (Detailed Workflow)
###############################################################################
### 3.1 ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ 

oot/
â”œâ”€ apps/
â”‚ â”œâ”€ webapp/ # Next.js UI
â”‚ â””â”€ websocket-server/# Media â†” OpenAI bridge
â”œâ”€ infra/ # CDK (TypeScript)
â”œâ”€ .github/
â”‚ â””â”€ workflows/ # build / deploy pipelines
â””â”€ docker-compose.yml # local integration test


### 3.2 Docker åŒ–
1. **webapp**: `Dockerfile` ã§ `FROM node:20-alpine`; `next build && next start`.  
2. **websocket-server**: expose 8080, `HEALTHCHECK CMD wget -qO- localhost:8080/healthz`.  
3. **multi-arch build** (`linux/amd64,arm64`) ã§ Graviton2 Fargate ã«å¯¾å¿œã€‚  

### 3.3 IaC (AWS CDK v2)
1. VPC (2 AZ) + Private Subnets  
2. ECR Repos (`webapp`, `ws-bridge`)  
3. ECS Cluster + Fargate Service (ALB, TG, SG)  
4. API Gateway HTTP API â†’ Lambda (`voiceWebhookFn`)  
5. Amplify Hosting (`nextjsApp`)  
6. Secrets Manager: `OPENAI_API_KEY`, `TWILIO_AUTH_TOKEN`, etc.  
7. Output: Webhook URL (`https://api.example.com/twilio/voice`)  

### 3.4 CI/CD (GitHub Actions)
- **on: push, pull_request**  
- Jobs: `build-deploy-webapp`, `build-deploy-ws`, `cdk-deploy-infra`  
- OIDC â†’ AWS STS AssumeRole ã§ãƒˆãƒ¼ã‚¯ãƒ³ãƒ¬ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚  

### 3.5 Twilio Console è¨­å®š
1. å—ä¿¡ç•ªå· â†’ Voice Webhook URL ã‚’ `POST` ã«è¨­å®šã€‚  
2. <Connect><Stream url="wss://bridge.example.com/media"/> ã‚’è¿”ã™ã€‚  

### 3.6 Observability
- Enable X-Ray on Lambda & ECS â†’ Trace Map ã§ E2E Latency å¯è¦–åŒ– :contentReference[oaicite:9]{index=9}  
- Custom CW Metric: `ActiveConnections` ã‚’ WS Bridge ã‹ã‚‰ PutMetricDataã€‚  

### 3.7 æ€§èƒ½ & ã‚¹ã‚±ãƒ¼ãƒ«æ¤œè¨¼
1. Locust / Artillery ã§ 10, 50, 100 åŒæ™‚é€šè©±ã‚’å†ç¾ã€‚  
2. ç¢ºèªé …ç›®:  
   - RTT < 300 ms (Tokyo â†’ Twilio US)  
   - ECS CPU < 70 %, Memory < 60 %  
   - Lambda p95 < 500 ms  

### 3.8 ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡
- OpenAI Realtime ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ä¸Šé™æ’¤å»ƒæ¸ˆã€‚ãŸã ã— **TPM/RPM** ã¯  
  Rate Limit Guide ã«å¾“ã„ãƒ˜ãƒƒãƒ‰ãƒ«ãƒ¼ãƒ  20 % ã‚’ç¢ºä¿ :contentReference[oaicite:10]{index=10}  

###############################################################################
# 4. éæ©Ÿèƒ½è¦ä»¶ (NFR)
###############################################################################
- **å¯ç”¨æ€§**â€ƒECS minCapacity=2 tasks / Multi-AZ, R53 Fail-over to ap-northeast-3  
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**â€ƒALB â†’ WAF, TLS via ACM; Secrets rotation 90 days.  
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**â€ƒTerraform state & CDK Synth artifacts to S3 (versioning).  
- **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹**â€ƒPII éŸ³å£°ã‚’ä¿å­˜ã™ã‚‹å ´åˆã¯ S3 SSE-KMS + 90 day Lifecycle.  

###############################################################################
# 5. ä»Šå¾Œã®ã‚¿ã‚¹ã‚¯ (Next Tasks)
###############################################################################
1. ğŸ¯  WebSocket Bridge ã® Unit / Integration Test (Jest + supertest).  
2. ğŸ¯  CDK Pipeline ã¸ *blue/green deploy* å°å…¥ (ECS CodeDeploy).  
3. ğŸ¯  Serverless SnapStart or Provisioned-Concur. Schedule æœ€é©åŒ–ã§ã‚³ã‚¹ãƒˆæ¸›ã€‚  
4. ğŸ¯  CloudWatch Alarm â†’ SNS â†’ Slack é€£æº (critical alerts).  
5. ğŸ¯  Documentation: ADRs, Runbooks, Post-mortem template æ•´å‚™ã€‚  

# EOF
